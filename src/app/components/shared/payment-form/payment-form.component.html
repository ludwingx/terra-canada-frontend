<div class="payment-form-container" *ngIf="isVisible">
  <form [formGroup]="form" class="payment-form" (ngSubmit)="onSubmit()">
    <!-- SECCIÓN 1: PARTES INVOLUCRADAS -->
    <div class="form-section">
      <h4 class="section-title">{{ 'partesInvolucradas' | translate }}</h4>
      
      <div class="form-row">
        <!-- Cliente Field -->
        <div class="form-group">
          <label>{{ 'cliente' | translate }} *</label>
          <div class="combobox-wrapper">
            <div class="combobox-input-container">
              <input
                type="text"
                formControlName="clienteNombre"
                class="form-control combobox-input"
                [placeholder]="'buscarClientePlaceholder' | translate"
                (focus)="onClienteFocus()"
                (blur)="onClienteBlur()"
                autocomplete="off"
              />
              <i class="pi pi-chevron-down combobox-icon" *ngIf="!mostrarClientesDropdown"></i>
              <i class="pi pi-chevron-up combobox-icon" *ngIf="mostrarClientesDropdown"></i>
            </div>
            
            <div class="combobox-dropdown" *ngIf="mostrarClientesDropdown">
              <div class="combobox-list">
                <div class="combobox-item combobox-item-add" (click)="abrirModalNuevoCliente()">
                  <i class="pi pi-plus"></i>
                  <span>{{ 'agregarNuevoCliente' | translate }}</span>
                </div>
                <div class="combobox-divider" *ngIf="clientesFiltrados.length > 0"></div>
                <div class="combobox-item" *ngFor="let cliente of clientesFiltrados" (click)="seleccionarCliente(cliente)">
                  <span class="item-text">{{ cliente.nombre }}</span>
                  <i class="pi pi-check item-check" *ngIf="form.get('cliente')?.value == cliente.id"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Proveedor Field -->
        <div class="form-group">
          <label>{{ 'proveedor' | translate }} *</label>
          <div class="combobox-wrapper">
            <div class="combobox-input-container">
              <input
                type="text"
                formControlName="proveedorNombre"
                class="form-control combobox-input"
                [placeholder]="'buscarProveedorPlaceholder' | translate"
                (focus)="onProveedorFocus()"
                (blur)="onProveedorBlur()"
                autocomplete="off"
              />
              <i class="pi pi-chevron-down combobox-icon" *ngIf="!mostrarProveedoresDropdown"></i>
              <i class="pi pi-chevron-up combobox-icon" *ngIf="mostrarProveedoresDropdown"></i>
            </div>
            
            <div class="combobox-dropdown" *ngIf="mostrarProveedoresDropdown">
              <div class="combobox-list">
                <div class="combobox-item combobox-item-add" (click)="abrirModalNuevoProveedor()">
                  <i class="pi pi-plus"></i>
                  <span>{{ 'agregarNuevoProveedor' | translate }}</span>
                </div>
                <div class="combobox-divider" *ngIf="proveedoresFiltrados.length > 0"></div>
                <div class="combobox-item" *ngFor="let proveedor of proveedoresFiltrados" (click)="seleccionarProveedor(proveedor)">
                   <div class="item-content">
                    <span class="item-text">{{ proveedor.nombre }}</span>
                    <span class="item-service">{{ proveedor.servicio }}</span>
                  </div>
                  <i class="pi pi-check item-check" *ngIf="form.get('proveedor')?.value == proveedor.id"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Correo Field -->
      <div class="form-group form-group-full">
        <label>{{ 'correo' | translate }}</label>
        <div *ngIf="mostrarDropdownCorreos" class="correo-selector">
          <div class="correo-dropdown-wrapper">
            <button type="button" class="correo-dropdown-btn" (click)="mostrarDropdownCorreos = !mostrarDropdownCorreos">
              {{ form.get('correo')?.value || ('seleccionarCorreo' | translate) }}
              <i class="pi pi-chevron-down"></i>
            </button>
            <div class="correo-dropdown-list" *ngIf="mostrarDropdownCorreos">
              <div class="correo-item" *ngFor="let correo of correosDisponibles" (click)="seleccionarCorreo(correo)">
                {{ correo }}
              </div>
            </div>
          </div>
        </div>
        <input *ngIf="!mostrarDropdownCorreos" type="email" formControlName="correo" class="form-control" [placeholder]="'correoProveedorPlaceholder' | translate" readonly />
      </div>
    </div>

    <!-- SECCIÓN 2: INFORMACIÓN DEL PAGO -->
    <div class="form-section">
      <h4 class="section-title">{{ 'informacionPago' | translate }}</h4>

      <div class="form-row">
        <!-- Moneda -->
        <div class="form-group">
          <label>{{ 'monedaLabel' | translate }} *</label>
          <select formControlName="moneda" class="form-control">
            <option value="">{{ 'seleccioneMoneda' | translate }}</option>
            <option *ngFor="let moneda of monedasDisponibles" [value]="moneda.id">{{ moneda.nombre }}</option>
          </select>
        </div>

        <!-- Tarjeta -->
        <div class="form-group">
          <label>{{ 'tarjeta' | translate }} *</label>
          <select formControlName="tarjeta" class="form-control" [disabled]="!monedaSeleccionada">
            <option value="">{{ monedaSeleccionada ? ('seleccioneTarjeta' | translate) : ('seleccioneMonedaPrimero' | translate) }}</option>
            <option *ngFor="let tarjeta of tarjetasFiltradas" [value]="tarjeta.id">
              {{ tarjeta.nombreTitular }} - ****{{ tarjeta.ultimos4Digitos }}
            </option>
          </select>
        </div>

        <!-- Monto -->
        <div class="form-group">
          <label>{{ 'monto' | translate }} *</label>
          <input type="number" formControlName="monto" class="form-control" placeholder="0.00" step="0.01" min="0" />
        </div>

        <!-- Fecha Futura -->
        <div class="form-group" *ngIf="form.get('fechaFutura')">
          <label>Fecha futura (opcional)</label>
          <div class="date-input-row" [ngClass]="{ 'is-focused': fechaFuturaFocused }">
             <span class="icon-chip"><i class="pi pi-calendar"></i></span>
             <div class="input-wrapper">
                <p-datepicker
                    #cal
                    [showButtonBar]="false"
                    [showTime]="true"
                    hourFormat="24"
                    appendTo="body"
                    panelStyleClass="tc-calendar-panel"
                    inputStyleClass="tc-date-input"
                    [placeholder]="'jj/mm/aaaa hh:mm'"
                    [ngModelOptions]="{ standalone: true }"
                    [(ngModel)]="draftFechaFutura"
                    (ngModelChange)="applyDraftFechaFutura($event)"
                    (onShow)="syncDraftFechaFutura()"
                    (onFocus)="fechaFuturaFocused = true"
                    (onBlur)="fechaFuturaFocused = false"
                    (onHide)="fechaFuturaFocused = false; revertDraftFechaFutura()"
                >
                    <ng-template pTemplate="footer">
                        <div class="calendar-footer-actions">
                            <button type="button" class="btn btn-secondary" (click)="clearDraftFechaFutura()">Limpiar</button>
                            <button type="button" class="btn btn-secondary" (click)="setDraftFechaFuturaToNow()">Hoy</button>
                        </div>
                    </ng-template>
                </p-datepicker>
             </div>
          </div>
        </div>
      </div>

      <!-- N° Presta -->
      <div class="form-group form-group-full">
         <div class="numero-presta-header" *ngIf="enableAutomaticNumeroPresta; else simpleNumeroPrestaLabel">
           <label>{{ 'numeroPresta' | translate }} *</label>
           <div class="numero-presta-toggle">
             <label class="toggle-option">
               <input type="radio" name="numeroPrestaModo" [checked]="!numeroPrestaAutomatico" (change)="setNumeroPrestaModo(false)" />
               <span>{{ 'manual' | translate }}</span>
             </label>
             <label class="toggle-option">
               <input type="radio" name="numeroPrestaModo" [checked]="numeroPrestaAutomatico" (change)="setNumeroPrestaModo(true)" />
               <span>{{ 'automatico' | translate }}</span>
             </label>
           </div>
         </div>
         <ng-template #simpleNumeroPrestaLabel>
             <label>{{ 'numeroPresta' | translate }} *</label>
         </ng-template>
         <input type="text" formControlName="numeroPresta" class="form-control" [readonly]="numeroPrestaAutomatico" />
         <div class="form-error" *ngIf="numeroPrestaError">{{ numeroPrestaError }}</div>
      </div>
    </div>

    <!-- SECCIÓN 3: NOTAS -->
    <div class="form-section">
      <h4 class="section-title">{{ 'notasAdicionales' | translate }}</h4>
      <div class="form-group form-group-full">
        <label>{{ 'comentarios' | translate }}</label>
        <textarea formControlName="comentarios" class="form-control notes-textarea" rows="3"></textarea>
      </div>
    </div>

    <div class="form-actions">
      <button type="button" class="btn btn-secondary" (click)="onCancel()">{{ 'cancelar' | translate }}</button>
      <button type="submit" class="btn btn-primary" [disabled]="form.invalid">{{ 'registrarPago' | translate }}</button>
    </div>
  </form>

  <!-- Modals (Simplified) -->
  <div class="modal-overlay" *ngIf="mostrarModalNuevoCliente" (click)="cerrarModalNuevoCliente()">
      <div class="modal-content" (click)="$event.stopPropagation()">
          <div class="modal-header">
              <h2>{{ 'agregarNuevoCliente' | translate }}</h2>
          </div>
          <div class="modal-body">
              <div class="form-group">
                  <label>Nombre</label>
                  <input type="text" [(ngModel)]="nuevoClienteNombre" class="form-control" [ngModelOptions]="{standalone: true}" placeholder="Nombre" />
              </div>
              <!-- Other fields ... -->
          </div>
          <div class="modal-footer">
              <button class="btn btn-secondary" (click)="cerrarModalNuevoCliente()">Cancelar</button>
              <button class="btn btn-primary" (click)="guardarNuevoCliente()">Guardar</button>
          </div>
      </div>
  </div>

  <div class="modal-overlay" *ngIf="mostrarModalNuevoProveedor" (click)="cerrarModalNuevoProveedor()">
      <div class="modal-content" (click)="$event.stopPropagation()">
          <div class="modal-header">
              <h2>{{ 'agregarNuevoProveedor' | translate }}</h2>
          </div>
          <div class="modal-body">
              <div class="form-group">
                  <label>Nombre</label>
                  <input type="text" [(ngModel)]="nuevoProveedorNombre" class="form-control" [ngModelOptions]="{standalone: true}" placeholder="Nombre" />
              </div>
               <!-- Other fields ... -->
          </div>
          <div class="modal-footer">
              <button class="btn btn-secondary" (click)="cerrarModalNuevoProveedor()">Cancelar</button>
              <button class="btn btn-primary" (click)="guardarNuevoProveedor()">Guardar</button>
          </div>
      </div>
  </div>
</div>
